worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    include       '../nginx/conf/mime.types';
    default_type  application/octet-stream;

    log_format lfmain           '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for" "$sent_http_content_type" "$gzip_ratio"';
    log_format lfupstream       '$time_iso8601 | $remote_addr | $remote_user | $scheme://$server_name:$server_port -> $upstream_addr | $status -> $upstream_status | $request_time -> $upstream_response_time | "$sent_http_content_type" | $gzip_ratio | "$request"';

    access_log              logs/access.log lfmain;

    sendfile                on;
    tcp_nopush              on;
    tcp_nodelay             on;
    keepalive_requests      1000;
    keepalive_timeout       120;
    client_max_body_size    256M;

    ### compression settings
    gzip                    on;
    gzip_disable            "msie6";
    gzip_vary               on;
    gzip_min_length         128;
    gzip_buffers            128 32k;
    gzip_comp_level         6;
    gzip_proxied            any;
    gzip_types              text/plain text/css text/x-component text/xml
                            application/xml application/xhtml+xml application/json
                            image/x-icon image/bmp image/x-windows-bmp image/svg+xml application/atom+xml
                            text/javascript application/javascript application/x-javascript
                            application/pdf application/postscript
                            application/rtf application/msword
                            application/vnd.ms-powerpoint application/vnd.ms-excel
                            application/vnd.ms-fontobject application/vnd.wap.wml
                            application/x-font-ttf application/x-font-opentype;

    ### proxy settings
    proxy_redirect off;
    proxy_intercept_errors on;
    proxy_http_version 1.1;
    proxy_set_header Host               $http_host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_set_header X-NginX-Proxy      true;
    proxy_set_header Upgrade            $http_upgrade;
    proxy_set_header Connection         "upgrade";
    proxy_read_timeout                  3600s;
    proxy_send_timeout                  3600s;

    # -------------------------------------------------------------------------
    # HTTP(S) server
    # -------------------------------------------------------------------------
    #server {
    #   listen      80;
    #   return 301  https://$host$request_uri;
    #}

    server {
        listen      80;
        listen      443 ssl;
        server_name localhost;

        # only useful in case of HTTPS. HSTS headers over HTTP are ignored...
        # see: https://developer.mozilla.org/en-US/docs/Web/Security/HTTP_strict_transport_security
        add_header Strict-Transport-Security "max-age=31536000" always;

        ssl_certificate             cert.pem;
        ssl_certificate_key         private.pem;
        ssl_session_cache           shared:SSL:10m;
        ssl_session_timeout         10m;
        ssl_prefer_server_ciphers   on;

        #error_page  404                /404.html;
        error_page  500 502 503 504     /50x.html;


        if ($scheme != "https") {
            #return 301 https://$host$request_uri;
            set $rewrite 1;
        }
        # following IPs will be allowed access over HTTP (modify as needed)
        if ($remote_addr ~  "^(localhost|127.0.0.1|10.11.|10.70.)") {
            set $rewrite 0;
        }
        if ($rewrite = 1) {
            return 301 https://$host$request_uri;
        }

        location = /50x.html {
            root   html;
        }

        ### proxy EXA to Node JS
        location / {
            access_log  logs/exa.proxy.log lfupstream;
            proxy_pass  http://app_exa/;
        }

        ### proxy EXA HTTP WADO requests
        location /wado {
            access_log  logs/exa_http_wado.proxy.log lfupstream;
            proxy_pass http://app_exa_http_wado;
        }

        ### proxy EXA API instance (uncomment if using 'api mode'):
        ###     nssm install EXA_Web_APIs "C:\Program Files\nodejs\node.exe" "C:\viztek\EXA\web\app.js" "env=production port=8091 mode=api"
        #location /api/cstore {
        #    #access_log  logs/exa_api_cstore.proxy.log lfupstream;
        #    proxy_pass http://app_exa_api_cstore;
        #}

        ### proxy Cardio Viewer to MS IIS
        location /EXA_Cardio/ {
            access_log  logs/exa_cardio.proxy.log lfupstream;
            proxy_pass  http://app_exa_cardio/EXA_Cardio/;
        }

        ### proxy TX Control to MS IIS
        location /Txtranscription/ {
            access_log  logs/txtranscription.proxy.log lfupstream;
            proxy_pass  http://app_txtranscription/Txtranscription/;
        }

        ### proxy jsreport
        location /reporting/ {
            access_log  logs/jsreport.proxy.log lfupstream;
            proxy_pass  http://app_jsreport/;    # trailing slash is critical !!!
        }

        ### serve all EXA public assets (directories & root files) via nginx
        location ~ ^/(bootstrap?.+|fonts|fullcalendar?.+|images|javascripts|jqgrid|jsoneditor|resx|stylesheets|tinymce|uploaddocuments)/.+$ {
            root        '../exaWEB/public';
            expires     max;
            #access_log off;
        }
        location ~ ^/(offline.html|robots.txt|favicon.ico|hipaa.pdf|mobileRad.apk|pacs.apk)$ {
            root        '../exaWEB/public';
            expires     max;
            #access_log off;
        }
        location /web_tools/ {
            alias       '../web_tools/';
            expires     max;
            #access_log off;
        }
		
		location /qr {
            proxy_pass https://exa_qr_api;
        }
    }

    # -------------------------------------------------------------------------
    # Upstream servers
    # -------------------------------------------------------------------------
    upstream app_exa {
        #ip_hash;
        server 127.0.0.1:8081;
        #server 127.0.0.1:8083;
        #server 127.0.0.1:8082;
    }

    upstream app_exa_http_wado {
        #least_conn;
        server 127.0.0.1:8421;

        keepalive 64;
    }

    upstream app_exa_api_cstore {
        #least_conn;
        server 127.0.0.1:8091;
        #server 127.0.0.1:8092;
        #server 127.0.0.1:8093;

        keepalive 64;
    }

    upstream app_exa_cardio {
        server 127.0.0.1:90;

        keepalive 64;
    }

    upstream app_txtranscription {
        server 192.168.1.103:90;

        keepalive 64;
    }
	
	 upstream exa_qr_api {
        least_conn;
        server 127.0.0.1:9876;
        keepalive 64;
    }

    upstream app_jsreport {
        server 127.0.0.1:5488;

        keepalive 64;
    }

}
