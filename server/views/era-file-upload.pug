doctype html
html
    head
        title EOB File Upload

        link(rel='stylesheet', href=staticAssetsRoot + '/node_modules/bootstrap/dist/css/bootstrap.min.css')

    script.
            function fireUpload(e) {
                var id = e.target.id.replace(/btn/g, '');

                if(e.target.name === 'uploadPDF') {
                    document.getElementById("hdnMode").value = `${id}_PDF`;
                    document.getElementById("eraPDFFile").click();
                } else {
                    document.getElementById("hdnMode").value = id;
                    document.getElementById("eraFile").click();
                }

                return false;
            }

            function doImport(e, billingRegionCode, allowedExtensions) {
                const fileExtension = e.target.files[0].name.slice(-4);
                allowedExtensions = allowedExtensions || "";

                if (!allowedExtensions.includes(fileExtension) && e.target.id !== 'eraPDFFile' && billingRegionCode !== 'can_AB') {
                    parent.commonjs.showError(`Allowed file extensions: ${allowedExtensions.replaceAll('.','')}`);
                    e.target.form.reset();
                    return;
                } else if(e.target.id === 'eraPDFFile' && !/pdf/i.test(fileExtension)) {
                     parent.commonjs.showError('Allowed file extensions: pdf');
                     e.target.form.reset();
                     return;
                }

                parent.commonjs.showLoading('Uploading file. please wait..');
                document.getElementById("inSubmit").click();
                var btns = parent.document.getElementsByClassName('eobControls');

                for(var i = 0; i < btns.length; i++){
                    btns[i].style.display = 'block';
                }
            }

            function download(e) {
                $('#btnDownload_EOB').attr('disabled', "disabled");
                var loadingMsg = parent.commonjs.geti18NString('billing.era.eraDownloadingStatus');
                parent.commonjs.showLoading(loadingMsg);

                $.ajax({
                    type: "GET",
                    url: "/exa_modules/billing/era/download",
                    data: {},
                    success: function(result) {
                        parent.commonjs.hideLoading();
                        if(result && result.status == 'error') {
                            parent.commonjs.showWarning(result.message);
                        } else {
                            parent.commonjs.showStatus(result.message);
                        }
                        var reloadERA = parent.document.getElementById('btnReloadERA');
                        reloadERA && reloadERA.click();
                        $('#btnDownload_EOB').removeAttr("disabled");
                    },
                    error: function (err, response) {
                        parent.commonjs.handleXhrError(err, response);
                        $('#btnDownload_EOB').removeAttr("disabled");
                    },
                    dataType: 'json'
                });
            }

    body(class="exportFrame" style="background-color: transparent !important;")
        form#eraFileUpload(name='formEraUpload', action='/exa_modules/billing/era/upload?_csrf=' + csrfToken, method='POST', style="float:right;", enctype="multipart/form-data")
            input(type="hidden", name="_csrf", value='#{csrfToken}')
            button#btnDownload_EOB.eraProcessButton.btn.btn-primary.btn-sm(type="button", onClick="download(event);", style="background: #3c91f0; margin-top: 4px; margin-right: 5px;", i18n="shared.buttons.download")
            button#btnProcess_EOB.eraProcessButton.btn.btn-primary.btn-sm(type="button", onClick="fireUpload(event);", style="background: #3c91f0; margin-top: 4px; margin-right: 5px;", i18n="shared.fields.uploadProcessEOBFile")
            if ['can_MB', 'can_BC'].indexOf(billingRegionCode) == -1
                button#btnPreview_EOB.eraProcessButton.btn.btn-primary.btn-sm(type="button", onClick="fireUpload(event);", style="background: #3c91f0; margin-top: 4px;", i18n="shared.fields.previewEOBFile")

            input#eraFile(type="file", name="displayImage", onchange="doImport(event,'" + billingRegionCode +"','" + allowedExtensions +"');", style="visibility:hidden; height:0px; width: 0px" )
            input#eraPDFFile(type="file", name="displayImage", onchange="doImport(event,'" + billingRegionCode +"');", accept="application/pdf" style="visibility:hidden; height:0px; width: 0px" )
            input#inSubmit(type="submit", style="visibility:hidden;height:0px")

            span#fileNameUploaded(style="display:none") #{fileNameUploaded}
            span#hdnPreviewFileName(style="display:none") #{previewFileName}
            span#fileStoreExist(style="display:none") #{file_store_status}
            span#fileIsDuplicate(style="display:none") #{duplicate_file}
            span#fileStatus(style="display:none") #{status}

            input#hdnMode(type="text", style="visibility:hidden;height:0px", name="mode")

    script(type='text/javascript', src=staticAssetsRoot + '/node_modules/requirejs/require.js')
    script(type='text/javascript', src=staticAssetsRoot + '/node_modules/underscore/underscore.js')
    script.
        parent.commonjs.hideLoading();
        var reloadERA = parent.document.getElementById('btnReloadERA');
        var reloadEob = parent.document.getElementById('btnReloadEOB');

        if (reloadERA) {
            reloadERA.click();
        }

        if (reloadEob) {
            reloadEob.click();
        }
        window.app = {};

        var rjsConfig = {
            waitSeconds: 0,
            paths: {
                'jquery': '/exa_modules/billing/static/node_modules/jquery/dist/jquery',
                'i18nscript': '/exa_modules/billing/static/js/shared/i18n',
            },
            shim: {
                'jquery': {
                   exports : 'jquery'
                },
                'i18nscript': {
                    deps: ['jquery'],
                    exports: 'i18n'
                },
            }
        };

        if (require && require.config) {
            require.config(rjsConfig);

            require([
                'jquery',
                'i18nscript'
            ], function(
                $,
                i18n
            ) {
                i18n.text = parent.i18n.text;
                i18n.currentLang = parent.i18n.currentLang;
                i18n.t();
            });
        }
